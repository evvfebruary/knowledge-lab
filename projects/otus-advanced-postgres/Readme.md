# PostgreSQL.Advanced

### –õ–µ–∫—Ü–∏—è 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Postgres

```
–û–ø–∏—Å–∞–Ω–∏–µ/–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è:
*–û–¥–Ω–∞–∂–¥—ã —É—Ç—Ä–æ–º –ê–ª–µ–∫—Å–µ–π –ø–æ–ª—É—á–∏–ª —Å—Ä–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ—Ç–¥–µ–ª–∞ –ª–æ–≥–∏—Å—Ç–∏–∫–∏: "–ú—ã –Ω–µ –º–æ–∂–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—Ç–∏–∏ –±–∞–Ω–∞–Ω–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤ –ï–≤—Ä–æ–ø—É!" –û–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ –¥–∏—Å–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã, –≥–¥–µ —Ä–∞–±–æ—Ç–∞–ª–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –±—ã–ª –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ 95%. –ê–ª–µ–∫—Å–µ–π –ø–æ–Ω—è–ª, —á—Ç–æ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤–æ–≤—Ä–µ–º—è, —ç—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –∑–∞–¥–µ—Ä–∂–∫–∞–º –ø–æ—Å—Ç–∞–≤–æ–∫ –∏ —à—Ç—Ä–∞—Ñ–∞–º –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤.

–ü—Ä–∏—á–∏–Ω–æ–π –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–µ—Å—Ç–∞ —Å—Ç–∞–ª–æ –Ω–µ —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –∏ –æ—à–∏–±–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö: –ª–æ–≥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (WAL-—Ñ–∞–π–ª—ã) –∑–∞–Ω–∏–º–∞–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞, —Ç–∞–∫ –∫–∞–∫ –Ω–∏–∫—Ç–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–∏–ª –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—á–∏—Å—Ç–∫—É.
–ê–ª–µ–∫—Å–µ–π —Ä–µ—à–∏–ª, —á—Ç–æ –Ω—É–∂–Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ, –Ω–æ –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –±—É–¥—É—â–µ–µ.
–û–Ω —Ä–µ—à–∏–ª –¥–æ–±–∞–≤–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –¥–∏—Å–∫ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç—É–¥–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –û–¥–Ω–∞–∫–æ –Ω–∞ –ø—É—Ç–∏ –∫ —É—Å–ø–µ—Ö—É –µ–≥–æ –∂–¥–∞–ª–∏ –Ω–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã:

–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –¥–∏—Å–∫?
–ö–∞–∫ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ, –Ω–µ –ø–æ—Ç–µ—Ä—è–≤ –∏—Ö?
–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å PostgreSQL, —á—Ç–æ–±—ã –æ–Ω —Ä–∞–±–æ—Ç–∞–ª —Å –Ω–æ–≤—ã–º –¥–∏—Å–∫–æ–º?
–ê–ª–µ–∫—Å–µ–π –∑–Ω–∞–ª, —á—Ç–æ –æ—Ç –µ–≥–æ –¥–µ–π—Å—Ç–≤–∏–π –∑–∞–≤–∏—Å–∏—Ç —É—Å–ø–µ—Ö –∫–æ–º–ø–∞–Ω–∏–∏: –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã, —ç—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —Å—Ä—ã–≤—É –ø–æ—Å—Ç–∞–≤–æ–∫ –∏ –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤—É –∫–ª–∏–µ–Ω—Ç–æ–≤.*

üéØ –ó–∞–¥–∞–Ω–∏–µ

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —à–∞–≥–∏ –ê–ª–µ–∫—Å–µ—è:

–°–æ–∑–¥–∞–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É —Å Ubuntu 20.04 –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL 15 –∏–ª–∏ –≤—ã—à–µ.
–°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–µ—Ä–µ–≤–æ–∑–∫–∞—Ö.
–î–æ–±–∞–≤—å—Ç–µ –≤–Ω–µ—à–Ω–∏–π –¥–∏—Å–∫ –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ –∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ —Ç—É–¥–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ PostgreSQL –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º –¥–∏—Å–∫–æ–º.
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –∏ –¥–æ—Å—Ç—É–ø–Ω—ã.
```

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

–†–µ—à–∏–ª –Ω–µ –¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤ –æ–±–ª–∞–∫–µ, –Ω–æ —Å–∏–º—É–ª–∏—Ä—É–µ–º —Ç—É –∂–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É –∏—Å–ø–æ–ª—å–∑—É—è docker

**Docker Compose**
```yaml
services:
  db:
    image: postgres:15
    container_name: pg15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: logistics
    ports:
      - "5432:5432"
    volumes:
      - pgdata_old:/var/lib/postgresql/data
      - pgdata_new:/var/lib/postgresql/newdata
      - ./conf/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    command:
      - "postgres"
      - "-c"
      - "config_file=/etc/postgresql/postgresql.conf"
volumes:
  pgdata_old:
  pgdata_new:
```

–° –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º:
```
# Point PG at the "old disk"
data_directory = '/var/lib/postgresql/olddata'

listen_addresses = '*'
shared_buffers = '256MB'
max_wal_size = '2GB'
checkpoint_timeout = '15min'
log_checkpoints = on
```

–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã
```sql
-- –°–æ–∑–¥–∞–¥–∏–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫—É—é —Ç–∞–±–ª–∏—á–∫—É –ø–µ—Ä–µ–≤–æ–∑–æ–∫
create table transitions (
    uuid uuid,
    product varchar(64),
    quantity int4,
    route_from varchar(64),
    route_to varchar(64)
);

-- –ß—É—Ç—å —á—É—Ç—å –µ–µ –Ω–∞–ø–æ–ª–Ω–∏–º
INSERT INTO transitions (uuid, product, quantity, route_from, route_to) VALUES
('0d2cc4b8-8922-4e2f-a6b0-f9c9ab5b3900', 'Bananas',      1200, 'Ecuador',     'Rotterdam'),
('b7e54a98-4ef1-4281-b5e4-cb88b6dc182a', 'Bananas',      800,  'Rotterdam',   'Hamburg'),
('7457a9ab-29a3-4494-9c87-bddb87fd2561', 'Mango',        500,  'Thailand',    'Frankfurt'),
('3908e1bd-2f59-4ddf-9545-bae459f1f3c3', 'Mango',        1400, 'Frankfurt',   'Oslo'),
('f71e7f83-f74d-4ef2-b7ac-2552cd9ee46c', 'Apples',       2000, 'Poland',      'Vienna'),
('f087aaf0-e3ff-431e-84a4-018a4a8dfc3c', 'Apples',       900,  'Vienna',      'Milan'),
('3b3847d6-2b5a-4ece-9a64-90d58bf88fec', 'Pineapple',    700,  'Costa Rica',  'Lisbon'),
('1396fe2e-8b37-46ed-9db7-f8df39e50afc', 'Pineapple',    1100, 'Lisbon',      'Madrid'),
('aa675720-27e4-4fc8-8627-63918bb5cbcd', 'Oranges',      600,  'Morocco',     'Paris'),
('84ce3f45-a7f8-4626-9ab5-59222cceec72', 'Oranges',      1200, 'Paris',       'London'),
('4962edfe-13d9-4a4a-8854-7b62b6bb6f29', 'Avocado',      400,  'Mexico',      'Rotterdam'),
('71c1790a-3a9e-41bf-afd3-7cd84776e33d', 'Avocado',      950,  'Rotterdam',   'Zurich'),
('8dfca176-6510-4043-b7c4-c33f3b3930d1', 'Bananas',      300,  'Hamburg',     'Prague'),
('c6057a35-17cf-4bcc-868e-5efb707d4d79', 'Apples',       1300, 'Milan',       'Barcelona'),
('157df5bd-4d71-4d86-bcc0-1cf76a7bb78a', 'Oranges',      1700, 'London',      'Dublin'),
('dc632a24-d305-4011-ab81-f80654131097', 'Mango',        450,  'Oslo',        'Trondheim'),
('46547f60-5e1a-4e96-8bde-d0141a6440b2', 'Avocado',      250,  'Zurich',      'Geneva'),
('09acbb63-1bcf-4f1e-8774-5a3bcc8e067b', 'Pineapple',    1500, 'Madrid',      'Milan'),
('d0cdfa64-1a0e-4fe4-bc57-33f8ee9cb004', 'Bananas',      2200, 'Prague',      'Warsaw'),
('89ac7abc-5737-4bea-908f-810aaefcaede', 'Oranges',      1000, 'Dublin',      'Amsterdam');

```

–ò–∑ —É—Å–ª–æ–≤–∏—è, –Ω–∞–º –≤–∏–¥–Ω–æ –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–º –ø—Ä–æ–±–ª–µ–º—ã:
- wal-–ª–æ–≥–∏ —Å–∏–ª—å–Ω–æ —Ä–∞—Å–ø—É—Ö–ª–∏
- —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö

–ß—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å, –æ—Ç–∫—É–¥–∞ –∏ –∫–∞–∫ –±—É–¥–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å, –ø–æ—Å–º–æ—Ç—Ä–∏–º –≥–¥–µ —Å–µ–π—á–∞—Å —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:
```SQL
SHOW data_directory;
-- /var/lib/postgresql/data <- –≤ –º–æ–µ–º —Å–ª—É—á–∞–µ
```

–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–µ—Å—Ç–∞:
```bash
drwx------ 19 postgres root     4.0K Nov 11 18:17 .
drwxr-xr-x  3 root     root     4.0K Nov 11 18:17 ..
drwx------  6 postgres postgres 4.0K Nov 11 18:17 base <- —Ç—É—Ç –º—ã—Ö
drwx------  4 postgres postgres 4.0K Nov 11 18:32 pg_wal
....
-rw-------  1 postgres postgres   88 Nov 11 18:17 postgresql.auto.conf
-rw-------  1 postgres postgres  32K Nov 11 18:17 postgresql.conf

```

–ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å volume `pgdata_new:/var/lib/postgresql/newdata`, 
–∫–æ—Ç–æ—Ä—ã–π –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –¥–∏—Å–∫.

–†–∞–∑–¥–∞–µ–º –Ω—É–∂–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–æ–≤–æ–π –ø–∞–ø–∫–µ ( –Ω–∞—à–µ–º—É –Ω–æ–≤–æ–º—É –¥–∏—Å–∫—É / volume )
```Bash
chown -R 999:999 /var/lib/postgresql/newdata && \
chmod 700 /var/lib/postgresql/newdata && \
# ensure all subdirs are at least 700 as well
find /var/lib/postgresql/newdata -type d -exec chmod 700 {} \;
```

```bash
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Ç–∏–ª–∏—Ç—É pg_basebackup –∏ —Ä–∞–∑–±–µ—Ä–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∑–∞–æ–¥–Ω–æ
pg_basebackup -U postgres -D /var/lib/postgresql/newdata -X stream -Fp -P -c fast
# -D - —Ç–∞—Ä–≥–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±—ç–∫–∞–ø–∞
# -X stream - –ø–µ—Ä–µ–¥–∞–µ—Ç wal –ø–æ—Ç–æ–∫–æ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
# -Fp ( --format=plain ), –≤—ã–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ 1:1 –∫–∞–∫ –≤ PGDATA, –∞ –Ω–µ –≤ tar.gz
# -P ( progress ), –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã
# -c ( --checkpoin=fast ), –±—ã—Å—Ç—Ä—ã–π —á–µ–∫–ø–æ–∏–Ω—Ç –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è
```

–¢–µ–ø–µ—Ä—å –º–µ–Ω—è–µ–º –≤ –∫–æ–Ω—Ñ–∏–≥–µ `data_directory` –Ω–∞:   
`data_directory = '/var/lib/postgresql/newdata'`

–ò –ø–µ—Ä–µ–∑–∞–ø—É–∫–∞–µ–º docker ( –Ω–∞ —Ö–æ—Å—Ç–µ –±—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª–∏ postgres ):
```bash
docker compose up -d force-recreate
```

–î–∞–ª—å—à–µ –º–æ–∂–µ–º –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è –≤ –¥–æ–∫–µ—Ä –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:
- data_directory –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–æ–≤—ã–π –¥–∏—Å–∫ ( volume )
- –¥–∞–Ω–Ω—ã–µ —Ç–∞–∫ –∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã

![work_with_new_directory.png](screenshots/work_with_new_directory.png)

P.S. –í —Ç–µ–∫—Å—Ç–µ –∑–∞–¥–∞–Ω–∏—è –µ—â–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å —Ç–µ–º, —á—Ç–æ –ª–æ–≥–∏ WAL –Ω–µ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è / –∞—Ä—Ö–∏–≤–∏—Ä—É—é—Ç—Å—è,    
–º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º. –ù–∞–ø—Ä–∏–º–µ—Ä –º—ã –ø–æ–¥–º–æ–Ω—Ç–∏—Ä—É–µ–º   
–æ—Ç–¥–µ–ª—å–Ω—ã–π –±–æ–ª–µ–µ –º–µ–Ω–µ–µ –¥–µ—à–µ–≤—ã–π HDD –¥–∏—Å–∫ –∏ –±—É–¥–µ–º —Ç—É–¥–∞ –∞—Ä—Ö–∏–≤—Ä–æ–≤–∞—Ç—å ( –∫–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç ) 

```yaml
archive_mode = on
archive_command = 'cp %p /mnt/archived_wal/%f'
```
